<%- include('head', {siteSection: 'Plugin docs', load: {}}); -%>
<%- include('nav'); %>

    <div class="container">
        <h1>Write your own plugins</h1>
        <p class="lead">Plugins enable the freeyourstuff.cc browser extension to retrieve your content for a supported website. We hope you decide to join the freeyourstuff.cc community and add support for your favorite sites.

        <p>freeyourstuff.cc is entirely written in <a href="https://en.wikipedia.org/wiki/JavaScript">JavaScript</a>. It consists of a browser extension and a <a href="https://en.wikipedia.org/wiki/Node.js">Node.js</a> web service. The browser extension loads the plugins; the Node.js service lets users upload and browse datasets. For the up-to-date list of currently supported sites, see the file <code><a href="https://github.com/eloquence/freeyourstuff.cc/blob/master/extension/sites.json">sites.json</a></code>.</p><p>To write a plugin, you'll need the following:</p>
        <ul>
            <li>a working knowledge of JavaScript and <a href="https://jquery.com/">jQuery</a>
            </li>
            <li>a working knowledge of Git/GitHub</li>
        </ul>
        <p>There are countless free resources to help you get started with JavaScript; we can recommend <a href="http://eloquentjavascript.net/">Eloquent JavaScript</a> by Marijn Haverbeke, <a href="http://exercism.io/">exercism.io</a> as an exercise platform, and <a href="http://nodeschool.io/">Nodeschool</a> for self-directed learning of Node.js.</p>
        <p>Basic familiarity with ECMASCript 6 (the latest version of JavaScript) is helpful; you may wish to consult the <a href="http://help.wtf/es6">ES6 cheatsheet</a> for quick reference.</p>
        <p>jQuery has its own <a href="https://learn.jquery.com/">learning center</a>; so does <a href="https://guides.github.com/">GitHub</a>. Finally, while programming, you may want to keep a <a href="https://devdocs.io/">DevDocs</a> tab open. As a code editor, we recommend <a href="https://atom.io/">Atom</a>, which has good Git integration. All of these tools are free and (except for GitHub itself) open source. Yay!</p>
        <p>With that out of the way, let's get started. First, you'll need a Git checkout of the freeyourstuff.cc repository. If you want to skip the Git part for now, you can <a href="https://github.com/eloquence/freeyourstuff.cc/archive/master.zip">download a ZIP file</a> that contains the latest version of the repository. To install the extension, unpack it into your working directory and then follow the instructions for <a href="https://developer.chrome.com/extensions/getstarted#unpacked">loading unpacked extensions</a>.</p>
        <p>As you work on the extension, you will sometimes have to reload it from your extensions list, but note that plugins are dynamically loaded so you should be able to skip that step while working on your plugin. The plugins themselves can be found in the <code><a href="https://github.com/eloquence/freeyourstuff.cc/tree/master/extension/src/plugins">extension/src/plugins</a></code> codepath. Go ahead and look at the contents of those folders. Each plugin's <code>index.js</code> contains the main code, while its <code>schema.json</code> describes the data the plugin can handle.</p>
        <p>To write a plugin, you don't need to worry too much about the main architecture of the extension. Still, you may want to take a look at Google's documentation of <a href="https://developer.chrome.com/extensions">Chrome extension development</a>. Essentially, our extension injects the plugin's JavaScript into a supported page like Yelp or Amazon.com. The plugin is a <a href="https://developer.chrome.com/extensions/content_scripts">content script</a> in Chrome extension terminology and runs in what's called an "isolated world"; it can't modify the scripts run by the site, but it can access the document, fetch pages from the same domain, and so on.</p>
        <h3>Messages, events and the Chrome API</h3>
        <p>A plugin communicates with the rest of the extension through <i>messages</i>, which it receives by listening for relevant <i>events</i> using the Chrome API. It can listen for messages from the extension's popup (the thing that opens when you click the button in the browser). These messages will typically tell it to go and fetch some data. Once it's done that, the plugin then sends a message back to a background page that's always listening. That way, we don't need to have the popup open to show the results.</p>
        <p>While it's doing its thing, a plugin can send little updates back to the popup, showing progress notices or error messages. A number of of convenience functions are provided for this purpose, which you can find in <code><a href="https://github.com/eloquence/freeyourstuff.cc/blob/master/extension/src/plugin.js">extension/src/plugin.js</a></code>.</p>
        <p>Use the <code>plugin.setup</code> function to ensure that your plugin code is only loaded when the document is ready. A plugin should call <code>plugin.busy()</code> when it is doing work, and <code>plugin.done()</code> when it is done working. These functions make sure that the button state and the spinner in the popup behave as they should.</p>
        <p>Within a plugin, you'll generally want to be careful with direct calls to the Chrome extension API. The reason is that plugins can also get called in the Node.js context for testing purposes, in which case that API is not available. A sane way to check for the existence of the API is the expression <code>typeof chrome !== 'undefined'</code>. We typically wrap extension-only code in functions and call them after this check.</p>
        <h3>Schemas and datasets</h3>
        <p>Plugins handle different kinds of data. We send data around in JavaScript's lightweight <a href="https://en.wikipedia.org/wiki/JSON">JSON</a> format, and we use very simple schemas to describe the data structure. The point of those schemas is primarily to ensure that we only stash the data we actually want, enforce type constraints, and can track schema changes.</p>
        <p>These schemas are pretty important; they're also used by the freeyourstuff.cc web service to parse data submissions and store them in its MongoDB backend. The schema system is still pretty basic and designed for textual data right now. We'll need to make changes to it over time to support new data types and more complex data structures.</p>
        <p>Check out <code><a href="https://github.com/eloquence/freeyourstuff.cc/blob/master/extension/src/examples/yelp.js">extension/src/examples/yelp.js</a></code> as an example of data represented by a schema, and the schema itself. If you view your local copy of <code><a href="https://github.com/eloquence/freeyourstuff.cc/blob/master/extension/src/result.html">extension/src/result.html</a></code> in your browser, it will attempt to render this data using <code><a href="https://github.com/eloquence/freeyourstuff.cc/blob/master/extension/src/result.js">extension/src/result.js</a></code>. You can use this method to verify that your schema and data are handled as expected -- feel free to submit pull requests for additional examples.</p>
        <p>Data is validated against its schema by <code><a href="https://github.com/eloquence/freeyourstuff.cc/blob/master/extension/src/dataset.js">extension/src/dataset.js</a></code>. A single schema describes all the kinds of data that can be stored for a given site (e.g., reviews, comments, blog posts). Together, we call this a <i>SiteSet</i>, while we call the sets that comprise it <i>DataSets</i>. Each DataSet has a header (for non-repeating information like the author) and rows of data. That's it.</p>
        <p>Note that descriptive metadata (like column titles) isn't parsed by <code>dataset.js</code>, but it <i>is</i> used in rendering results both in the extension and on the website. Simply follow the example and make sure you add longer descriptions and shorter labels for all your data. Right now we add the language code <code>'en'</code> for all labels and descriptions, so we can potentially support translations later.</p>
        <p>The schema version is a simple integer and should be increased with each update to the schema once the first data has been published (you can keep it at 1 while in development).</p>
        <h3>Plugin registration</h3>
        <p>To create a new plugin, first add the relevant directory under <code>extension/src/plugins</code> and create an <code>index.js</code> and <code>schema.json</code>. Keep directory and filenames all lowercase (use a hyphen for separating words), since not all platforms store files in a case-sensitive way.</p>
        <p>In addition, you will need to register a plugin in <code><a href="https://github.com/eloquence/freeyourstuff.cc/blob/master/extension/sites.json">extensions/sites.json</a></code>:</p>
        <ul>
            <li><code>name</code>: the proper name of the supported site as the site itself uses it.</li>
            <li><code>plugin</code>: the name of the subdirectory in which the plugin can be found</li>
            <li><code>deps</code>: (optional) additional JavaScript library dependencies (array). Currently supported: "papaparse" for CSV parser <a href="http://papaparse.com/">PapaParse</a>, "moment" for date/time library <a href="http://momentjs.com/">Moment.js</a>, and "numeral" for number parser <a href="http://numeraljs.com/">Numeral.js</a>
            <li><code>canonicalURL</code>: when we link to the site, what URL should we link to?</li>
            <li>
                <code>regex</code>: the regular expression the extension uses to show its icon, using a <a href="https://developer.chrome.com/extensions/declarativeContent#type-PageStateMatcher">PageStateMatcher</a>'s urlMatches rule, following <a href="https://github.com/google/re2">RE2 syntax</a>.
            </li>
            <li><code>supported</code>, <code>unsupported</code>: the types of content we can and cannot retrieve for the given site. This is only shown in the popup.</li>
            <li><code>extraPermissions</code>: (optional, true or false) whether we require full cross-origin permissions for the site (primarily needed if we need to visibly navigate); these will be requested at runtime using Chrome's <a href="https://developer.chrome.com/extensions/permissions">optional permissions</a> system</li>
        </ul>
        <p>Once you've added a plugin to sites.json, you will want to reload the extension to refresh the matching rules.</p>
        <h3>Retrieving data with jQuery</h3>
        <p>If you've not worked with your browser's developer tools before, for Chrome/Chromium, you may want to read the <a href="https://developer.chrome.com/devtools">dev tools tutorial</a> before getting started on your plugin in earnest. In many cases sites don't offer a full, unlimited API to get your data, so you'll need to process HTML. Dev tools help you analyze the page's layout, and jQuery makes it easy to process the HTML.</p>
        <p>A plugin can do everything that the user can do, though sometimes you'll have to jump through a few hoops to do it. freeyourstuff.cc is not a web scraping tool -- it's a tool for managing data you own. So a plugin should always first check that the user is logged in (a visual element you can use a jQuery selector on is a fine indicator).</p>
        <p>Depending on the content type you want to retrieve, you typically want to look for a page that shows all information of that type (all reviews, comments, posts, etc.). Take into account that there's usually some pagination for users with lots of content.</p>
        <p>What you have to do next depends on how the page is built. Use your dev tools to look at the browser's network requests to see if the page already arrives in your browser fully formed (static HTML) or if it's dynamically constructed using JavaScript requests.</p>
        <p>The former case is more common and more straightforward: you loop through the relevant elements using jQuery, stash them in an array, fetch follow-up pages as needed, and then finally send the result (schema-parsed using <code>dataset.js</code>) back to the extension.</p>
        <p>The latter case can get fairly hairy. You may have to figure out how a website's internal API works. This also often involves some kind of generated token which you have to extract from the page source. Check out the TripAdvisor plugin's AJAX code for an example of this. On the flip side, an API may be less fragile than the page's layout.</p>
        <p>The most complex plugins are the ones that have to anticipate complex AJAX requests and DOM changes. See the Quora plugin for how crazy this can get!</p>
        <h3>Basic tests</h3>
        <p>Many people don't like to write tests, but since plugins are likely to break every now and then, it's a requirement for any new plugin submission to at least be basically testable. Fortunately, that may be a matter of adding a single statement to your code:</p>
<pre>
window.freeyourstuff.tests = {
  someData: retrieveSomeData
};
</pre>
        <p>The testrunner in the <code><a href="https://github.com/eloquence/freeyourstuff.cc/tree/master/cli">cli</a></code> direcotry will attempt to run the functions defined in this variable for all plugins defined in <code>sites.json</code> and write the results to <code>tests/results/<i>pluginname</i>.<i>description</i>.json</code>, where <i>description</i> is the key in the <code>tests</code> object (e.g., "someData" in the example above).</p>
        <p>The testrunner depends on <a href="https://github.com/GoogleChrome/puppeteer">Puppeteer</a>, a Node.js library to control the Chromium browser in its headless mode (i.e. the browser is invisible, but otherwise behaves as a normal browser). You'll need to run <code>npm install</code> within the <code>cli/</code> directory in order to get all the packages the testrunner relies on, which includes a copy of the Chromium browser.</p>
        <p>Since we depend on user session data, you'll need to make a copy of your Chromium profile directory. This is the path under "Profile Path" in chrome://version/, <b>minus the "Default" bit at the end.</b> Copy this directory to ".chromium-testing-profile" in your home directory. You need to work with a copy, otherwise you run the risk of corrupting your profile! To run the tests, type <code>node bin/run-tests</code> from the <code>cli</code> directory, and add "--help" for some additional options. Some plugins let you specify a profile URL on the command line, but this feature is still very experimental.</p>
        <h3>Happy hacking!</h3>
        <p>freeyourstuff.cc is born out of a simple motivation -- we think users ought to be able to control the destiny of the content they contribute around the web. Whether this remains a singular experiment useful for a few websites or turns into a larger movement is entirely up to you! We hope you join us in turning this into a better tool, and look forward to your pull requests. You're welcome to subscribe to our <a href="http://www.freelists.org/list/freeyourstuff">mailing list for developers and users</a>. You can also find us on <b>irc.freenode.net</b> on the <code>#freeyourstuff</code> channel (you can <a href="https://webchat.freenode.net/?channels=freeyourstuff">use the web interface</a> if you're new to IRC).</p>
    </div>
<%- include('tail'); -%>
